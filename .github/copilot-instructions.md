---
description: AI rules derived by SpecStory from the project AI interaction history
globs: *
---

## <headers/>

## PROJECT RULES

*   The bot must be Ukrainian-language oriented.
*   The bot must be modular.
*   The bot must remember context for the entire duration of the chat.
*   The bot must interact with users in a group chat, responding to their messages and remembering the context.
*   The bot must have a function for random responses to messages when its name, tag, or related words are mentioned, to give it "its own life". These random responses should be generated by Gemini for maximum "liveliness".
*   The bot's persona must be maximally absurd.
*   The bot must use context and dynamically change its persona based on the environment in the chat.

## CODING STANDARDS

*   Use the latest versions of all libraries and frameworks.
*   Create a `.env` sample file for easy modification of variables.
*   The project structure should be modular, with separate modules for message processing, context storage, Gemini integration, and management.
*   All responses should be in Ukrainian.
*   All responses generated by the bot (not just random ones) must pass through Gemini with an absurd instruction.

## WORKFLOW & RELEASE RULES

## TECH STACK

*   Telegram bot library: aiogram.
*   Natural language and image/audio processing backend: Gemini (prioritize free Flash 2.5 if possible).
*   Database: SQLite (for storing chat context).

## PROJECT DOCUMENTATION & CONTEXT SYSTEM

*   Chat context (history) should be stored in a database (SQLite). JSON file storage is less efficient for large context.
*   Implement a function to import chat history from a Telegram JSON file into the bot's database, accessible only to the admin via the command `/import_history <path_to_json> <chat_id>`.
*   The bot should automatically store information about stickers, photos, and audio sent by each user, summarizing them with text to save space. If a sticker/photo/audio with the same ID is repeated, reuse the same description for context. An absurd or creative signature should be added to the media description, potentially generated via Gemini.
*   The database of messages should be compressed over time to fit within the model's context window. Context should be dynamically compressed before sending to the model, potentially by taking the last N thousand characters/messages.
*   Create a separate config file (e.g., `bot_config.py`) for the bot's personality, limits, timings, and admin ID. These values should be loaded from the `.env` file.
*   `BOT_CONTEXT_LIMIT` in the `.env` file defines the number of recent messages used to form the context for Gemini responses. While it can be increased, it's crucial to monitor the total context size to avoid exceeding Gemini's limits (ideally, stay within 10-30k characters for Flash 2.5). The bot should automatically compress the context if the limit is exceeded. This variable specifies the number of recent messages used to form the context. Recommended values: 50-200 for regular chats. Experiment for larger chats but monitor the total size.
*   A `media_map.py` module should be used to store unique descriptions of stickers, photos, and audio, reusing summaries for repeated media.
*   The bot's name is "Глек" and its tag is "@glek_bot". These, along with other variations like "глечик", should be used as triggers for random responses. The `TRIGGERS` list in the `random_life.py` module can be updated to add more variations.
*   Each message in the context should have a "mood" tag (e.g. "joke", "fight", "meme", "silence"), potentially determined by Gemini, and a short summary of the "environment" in the chat should be included when forming the prompt for Gemini.

## DEBUGGING

## REFERENCES

## BEST PRACTICES