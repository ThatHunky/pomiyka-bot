---
description: AI rules derived by SpecStory from the project AI interaction history
globs: *
---

## <headers/>

## PROJECT RULES

*   The bot must be Ukrainian-language oriented.
*   The bot must be modular.
*   The bot must remember context for the entire duration of the chat.
*   The bot must interact with users in a group chat, responding to their messages and remembering the context.
*   The bot must have a function for random responses to messages when its name, tag, or related words are mentioned, to give it "its own life". These random responses should be generated by Gemini for maximum "liveliness".
*   The bot's persona must be absurd, but not excessively so, and should maintain a degree of friendliness. The bot's style should be witty, supportive, and understandable.
*   The bot must use context and dynamically change its persona based on the environment in the chat.
*   The bot should have an anti-spam system with a limit on hourly replies, a minimum pause between spontaneous messages, and a smart reply chance on regular messages.
*   The bot should scan and add the chat history to the database when it first joins a chat.
*   The bot should automatically initialize chats when added to a new one, marking it as ready for operation.
*   The bot should send spontaneous messages from time to time, not in response to anything. These messages should start with 'üí≠'.
*   The bot should implement aggressive throttling, ignoring messages or responding with phrases like "—Ç—ñ—Ö–∞ –±–ª—è—Ç—å, —Ö–æ—Ö–ª–∏" when spammed. The bot should track the number of messages a user sends per minute and implement a timeout if a threshold is reached.
*   The bot should ignore old messages received while offline to prevent spamming upon restart.

## CODING STANDARDS

*   Use the latest versions of all libraries and frameworks.
*   Create a `.env` sample file for easy modification of variables.
*   The project structure should be modular, with separate modules for message processing, context storage, Gemini integration, and management.
*   All responses should be in Ukrainian.
*   All responses generated by the bot (not just random ones) must pass through Gemini with an absurd instruction.
*   Use try/catch blocks in all critical sections for error handling.
*   Use a single universal handler in `main.py` to prevent conflicts.
*   `.env` should be added to `.gitignore` to prevent committing secrets.

## WORKFLOW & RELEASE RULES

*   Add `.env` to `.gitignore` to prevent committing secrets.
*   Create a startup script (`start.py`) to verify dependencies.
*   The entire bot should be containerized for easy deployment.
*   Record version updates in CHANGELOG.

## TECH STACK

*   Telegram bot library: aiogram.
*   Natural language and image/audio processing backend: Gemini (prioritize free Flash 2.5 if possible). Consider using the latest Claude Sonnet 4 model from Anthropic.
*   Database: SQLite (for storing chat context).
*   Dependencies: python-dotenv, google-generativeai.

## PROJECT DOCUMENTATION & CONTEXT SYSTEM

*   Chat context (history) should be stored in a database (SQLite). JSON file storage is less efficient for large context.
*   Implement a function to import chat history from a Telegram JSON file into the bot's database, accessible only to the admin via the command `/import_history <path_to_json> <chat_id>`.
*   The bot should automatically store information about stickers, photos, and audio sent by each user, summarizing them with text to save space. If a sticker/photo/audio with the same ID is repeated, reuse the same description for context. Fast, absurd prefixes should be used for media descriptions instead of Gemini.
*   The database of messages should be compressed over time to fit within the model's context window. Context should be dynamically compressed before sending to the model, potentially by taking the last N thousand characters/messages.
*   Create a separate config file (e.g., `bot_config.py`) for the bot's personality, limits, timings, and admin ID. These values should be loaded from the `.env` file.
*   `BOT_CONTEXT_LIMIT` in the `.env` file defines the number of recent messages used to form the context for Gemini responses. While it can be increased, it's crucial to monitor the total context size to avoid exceeding Gemini's limits (ideally, stay within 10-30k characters for Flash 2.5). The bot should automatically compress the context if the limit is exceeded. This variable specifies the number of recent messages used to form the context. Recommended values: 50-200 for regular chats. Experiment for larger chats but monitor the total size.
*   A `media_map.py` module should be used to store unique descriptions of stickers, photos, and audio, reusing summaries for repeated media. The module should support voice and video, and use faster, non-Gemini generated prefixes for media descriptions.
*   The bot's name is now "–ì—Ä—è–≥" and its tag is "@gryag_bot". These, along with other variations (–≥—Ä—è–≥—ñ–∫, –≥—Ä—è–≥—É, –≥—Ä—è–≥–∞, –≥—Ä—è–≥–æ–º, –±–æ—Ç, –±–æ—Ç–µ), should be used as triggers for random responses. The `TRIGGERS` list in the `random_life.py` module can be updated to add more variations.
*   Each message in the context should have a "mood" tag (e.g. "joke", "fight", "meme", "silence"), potentially determined by Gemini, and a short summary of the "environment" in the chat should be included when forming the prompt for Gemini.
*   Add a `/clear_context` command.
*   Add a `/help` command.
*   Add a `/rescan` command, to force a rescan of the chat. This should be used if the bot was initially added without access to messages.
*   Add `random_reply_chance` and `max_context_size` parameters to `bot_config.py`.
*   The bot should use a smart reply chance, a minimum silence period, and a maximum number of replies per hour to prevent spamming. These values should be configurable via environment variables: `BOT_SMART_REPLY_CHANCE`, `BOT_MIN_SILENCE_MINUTES`, `BOT_MAX_REPLIES_PER_HOUR`, `BOT_AUTONOMOUS_MODE`, and `BOT_SPONTANEOUS_CHANCE`.
*   The bot should automatically initialize chats when added to a new one, marking it as ready for operation.
*   The bot should track scanned chats in `chat_states.json`.
*   The bot can import `chat.json` from Telegram Desktop via the `/import_history` command.
*   Implement a `/stats` command to show the number of messages and active chats.
*   The database, media map and chat states should be stored in the `data/` folder.
*   The bot should use environment variable `GEMINI_MODEL` to select a Gemini model. Default is `Gemini 2.5 Flash`.
*   Implement monitoring of API usage.
*   The bot should implement aggressive anti-spam throttling with configurable parameters: `BOT_SPAM_THRESHOLD`, `BOT_SPAM_TIMEOUT`, and `BOT_SPAM_REPLIES`.
*   The bot should send spontaneous messages from time to time. A background task should check every 5 minutes whether spontaneous activity is needed. Different prompts should be used depending on the mood of the chat (e.g., funny, sad, silence). The chance of a spontaneous message increases after a long silence (1-2 hours). Spontaneous messages should start with 'üí≠'.
*   Implement aggressive anti-spam throttling: track the number of messages a user sends per minute; if spamming (5+ messages per minute), set a timeout of 5 minutes; occasionally reply with phrases like "—Ç—ñ—Ö–∞ –±–ª—è—Ç—å, —Ö–æ—Ö–ª–∏", "–Ω–µ —Å–ø–∞–º—Ç–µ", "–∑–∞—Ç–∫–Ω—ñ—Ç—å—Å—è –Ω–∞ —Ö–≤–∏–ª–∏–Ω–∫—É" (30% chance), otherwise ignore.
*   The bot should use `BOT_SPONTANEOUS_CHANCE` and `BOT_SPONTANEOUS_MIN_PAUSE` variables in `.env` file to control spontaneous messages.
*   The bot should use `BOT_SPAM_THRESHOLD`, `BOT_SPAM_TIMEOUT`, and `BOT_SPAM_REPLIES` variables in `.env` file to control aggressive anti-spam throttling.
*   The bot should ignore old messages received while offline to prevent spamming upon restart. A message is considered old if its timestamp is older than `BOT_START_TIME`.

## DEBUGGING

*   Ensure random responses are handled asynchronously using `await`.

## REFERENCES

*   [GitHub Copilot serves Claude Sonnet 4](https://docs.github.com/en/copilot/using-github-copilot/ai-models/using-claude-sonnet-in-github-copilot).

## BEST PRACTICES

*   All admin commands should be processed through a single, absurd Gemini prompt, while maintaining a degree of friendliness.

## GEMINI API FREE LIMITS (June 2025)

### üíé **Free Models:**
*   **Gemini 2.5 Flash** (Recommended for bots)
*   **Gemini 2.0 Flash**
*   **Gemini 1.5 Flash/Pro**
*   **Text Embedding 004**
*   **Gemini 2.5 Pro** (Paid only)

### üìä **Free Tier Limits:**
*   **RPM** (Requests Per Minute): ~15-60 requests/min
*   **TPM** (Tokens Per Minute): Limited
*   **RPD** (Requests Per Day): Daily quotas
*   **Context Window**: Up to 1M tokens
*   **Data Usage**: Google uses data for product improvement

### üéØ **Optimizations for –ì—Ä—è–≥-bot:**
*   Anti-spam system with reply limits
*   Local context cache in SQLite
*   Absurd prefixes for media (token saving)
*   Configurable model via `.env`

### üöÄ **Recommendation:**
Use **Gemini 2.5 Flash** - best balance of quality, speed, and cost for chat bots.