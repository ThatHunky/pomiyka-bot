# –ü–æ–∫—Ä–∞—â–µ–Ω–∞ –æ–±—Ä–æ–±–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É —á–∞—Ç—É - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è

## –û–≥–ª—è–¥

–ú–æ–¥—É–ª—å `enhanced_behavior.py` —Ç–µ–ø–µ—Ä –≤–∫–ª—é—á–∞—î —Ä–æ–∑—É–º–Ω—É —Å–∏—Å—Ç–µ–º—É –æ–±—Ä–æ–±–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É —á–∞—Ç—É, —è–∫–∞ –∑–∞–ø–æ–±—ñ–≥–∞—î —Å–ø–∞–º—É —Ç–∞ –Ω–æ–Ω—Å–µ–Ω—Å—É –≤—ñ–¥ –±–æ—Ç–∞. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∞–Ω–∞–ª—ñ–∑—É—î –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –≤ —á–∞—Ç—ñ —Ç–∞ –∫–æ—Ä–µ–≥—É—î –ø–æ–≤–µ–¥—ñ–Ω–∫—É –±–æ—Ç–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ.

## –û—Å–Ω–æ–≤–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó

### 1. `process_message_with_smart_context()`

**–ì–æ–ª–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è** –¥–ª—è —Ä–æ–∑—É–º–Ω–æ—ó –æ–±—Ä–æ–±–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å.

```python
result = process_message_with_smart_context(
    message_text="–ì—Ä—è–≥, —â–æ –¥—É–º–∞—î—à?",
    chat_id=123,
    context=chat_context,
    recent_messages=recent_msgs
)
```

**–ü–æ–≤–µ—Ä—Ç–∞—î:**
- `should_respond` - —á–∏ –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏
- `response_tone` - —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∏–π —Ç–æ–Ω –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
- `spam_analysis` - –∞–Ω–∞–ª—ñ–∑ —Ä—ñ–≤–Ω—è —Å–ø–∞–º—É
- `context_quality` - —è–∫—ñ—Å—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç—É —Ä–æ–∑–º–æ–≤–∏
- `tone_instruction` - –≥–æ—Ç–æ–≤–∞ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è –¥–ª—è Gemini
- `recommendations` - —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó —â–æ–¥–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ

### 2. `analyze_chat_spam_level()`

–ê–Ω–∞–ª—ñ–∑—É—î —Ä—ñ–≤–µ–Ω—å —Å–ø–∞–º—É –≤ —á–∞—Ç—ñ:

```python
spam_info = analyze_chat_spam_level(chat_id, recent_messages)
```

**–†—ñ–≤–Ω—ñ —Å–ø–∞–º—É:**
- `low` - –Ω–æ—Ä–º–∞–ª—å–Ω–∞ –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å
- `medium` - –ø—ñ–¥–≤–∏—â–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å (15-30 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –∑–∞ 5 —Ö–≤)
- `high` - —Å–ø–∞–º (30+ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –∑–∞ 5 —Ö–≤)

### 3. `compress_context_smartly()`

–†–æ–∑—É–º–Ω–æ —Å—Ç–∏—Å–∫–∞—î –≤–µ–ª–∏–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç:

```python
compressed = compress_context_smartly(context, max_context_size=100)
```

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
1. –ó–±–µ—Ä—ñ–≥–∞—î –≤—Å—ñ –≤–∞–∂–ª–∏–≤—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (–∑–≥–∞–¥–∫–∏ –±–æ—Ç–∞, –ø–∏—Ç–∞–Ω–Ω—è, –¥–æ–≤–≥—ñ —Ç–µ–∫—Å—Ç–∏)
2. –î–æ–¥–∞—î –Ω–∞–π–Ω–æ–≤—ñ—à—ñ –∑–≤–∏—á–∞–π–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–æ –ª—ñ–º—ñ—Ç—É
3. –°–æ—Ä—Ç—É—î –∑–∞ —á–∞—Å–æ–º

### 4. `analyze_context_quality()`

–û—Ü—ñ–Ω—é—î —è–∫—ñ—Å—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç—É —Ä–æ–∑–º–æ–≤–∏:

```python
quality_info = analyze_context_quality(context)
```

**–†—ñ–≤–Ω—ñ —è–∫–æ—Å—Ç—ñ:**
- `high` - –∫–æ–≥–µ—Ä–µ–Ω—Ç–Ω–∞ —Ä–æ–∑–º–æ–≤–∞ (>70% —Å—Ö–æ–∂–∏—Ö —Ç–µ–º)
- `medium` - —Å–µ—Ä–µ–¥–Ω—è –∫–æ–≥–µ—Ä–µ–Ω—Ç–Ω—ñ—Å—Ç—å (40-70%)
- `poor` - —Ä–æ–∑–±–∏—Ç–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (<40%)

## –°–∏—Å—Ç–µ–º–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π

–ó–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Å–∏—Ç—É–∞—Ü—ñ—ó –≤ —á–∞—Ç—ñ, —Å–∏—Å—Ç–µ–º–∞ –≥–µ–Ω–µ—Ä—É—î —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó:

### –ü—Ä–∏ —Å–ø–∞–º—ñ:
- –ó–º–µ–Ω—à—É—î –¥–æ–≤–∂–∏–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ (`max_response_length`)
- –ó–º—ñ–Ω—é—î —Å—Ç–∏–ª—å –Ω–∞ `minimal` –∞–±–æ `concise`
- –†—ñ–∑–∫–æ –∑–Ω–∏–∂—É—î —à–∞–Ω—Å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ

### –ü—Ä–∏ –ø–æ–≥–∞–Ω–æ–º—É –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ:
- –î–æ–¥–∞—î —Ñ–ª–∞–≥ `should_ask_clarification`
- –í—Å—Ç–∞–Ω–æ–≤–ª—é—î `should_provide_guidance`
- –ó–º—ñ–Ω—é—î —Ç–æ–Ω –Ω–∞ `–Ω–∞–ø—Ä–∞–≤–ª—è—é—á–∏–π_–∂–∞—Ä—Ç`

## –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ –æ—Å–Ω–æ–≤–Ω–∏–º –±–æ—Ç–æ–º

### –£ —Ñ–∞–π–ª—ñ `main.py`:

```python
from bot.modules.enhanced_behavior import process_message_with_smart_context

async def handle_message(message):
    # –û—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç —á–∞—Ç—É
    context = await get_chat_context(message.chat.id)
    recent_messages = context[-20:]  # –û—Å—Ç–∞–Ω–Ω—ñ 20 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
    
    # –†–æ–∑—É–º–Ω–∞ –æ–±—Ä–æ–±–∫–∞
    analysis = process_message_with_smart_context(
        message.text,
        message.chat.id,
        context,
        recent_messages
    )
    
    # –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏
    if analysis['should_respond']:
        # –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó
        recommendations = analysis['recommendations']
        
        if recommendations['response_style'] == 'minimal':
            # –ö–æ—Ä–æ—Ç–∫–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –¥–ª—è —Å–ø–∞–º—É
            response = await generate_short_response(
                analysis['tone_instruction']
            )
        else:
            # –ó–≤–∏—á–∞–π–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å
            response = await generate_response(
                analysis['tone_instruction'],
                analysis['processed_context']
            )
        
        await message.reply(response)
    
    # –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø–æ–∫–∞–∑–∞—Ç–∏ –∞–Ω—Ç–∏-—Å–ø–∞–º –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    spam_level = analysis['spam_analysis']['spam_level']
    if spam_level in ['medium', 'high']:
        anti_spam_msg = get_anti_spam_message(spam_level)
        if anti_spam_msg and random.random() < 0.3:  # 30% —à–∞–Ω—Å
            await message.reply(anti_spam_msg)
```

## –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è

### –£ —Ñ–∞–π–ª—ñ `.env`:

```env
# –ö–æ–Ω—Ç—Ä–æ–ª—å —Å–ø–∞–º—É
BOT_SPAM_THRESHOLD=5          # –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –∑–∞ —Ö–≤–∏–ª–∏–Ω—É –¥–ª—è —Å–ø–∞–º—É
BOT_SPAM_TIMEOUT=300          # –¢–∞–π–º–∞—É—Ç –ø—Ä–∏ —Å–ø–∞–º—ñ (—Å–µ–∫—É–Ω–¥–∏)
BOT_SMART_REPLY_CHANCE=0.05   # –ë–∞–∑–æ–≤–∏–π —à–∞–Ω—Å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ (5%)

# –ö–æ–Ω—Ç–µ–∫—Å—Ç
BOT_CONTEXT_LIMIT=100         # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π —Ä–æ–∑–º—ñ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
BOT_MAX_MESSAGE_AGE_MINUTES=60 # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π –≤—ñ–∫ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å

# –ê–≤—Ç–æ–Ω–æ–º–Ω—ñ—Å—Ç—å
BOT_AUTONOMOUS_MODE=true
BOT_SPONTANEOUS_CHANCE=0.01   # 1% —à–∞–Ω—Å —Å–ø–æ–Ω—Ç–∞–Ω–Ω–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
BOT_MAX_REPLIES_PER_HOUR=2    # –ú–∞–∫—Å–∏–º—É–º –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π –Ω–∞ –≥–æ–¥–∏–Ω—É
```

## –õ–æ–≥—É–≤–∞–Ω–Ω—è —Ç–∞ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥

–°–∏—Å—Ç–µ–º–∞ –ª–æ–≥—É—î –≤–∞–∂–ª–∏–≤—ñ –ø–æ–¥—ñ—ó:

```python
# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±—Ä–æ–±–∫–∏
stats = get_processing_statistics(chat_id)
print(f"–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –∑–∞ –≥–æ–¥–∏–Ω—É: {stats['messages_last_hour']}")

# –õ–æ–≥—É–≤–∞–Ω–Ω—è –æ–±—Ä–æ–±–∫–∏
log_context_processing(chat_id, message_count, spam_level, context_quality)
```

## –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

–ó–∞–ø—É—Å—Ç—ñ—Ç—å —Ç–µ—Å—Ç –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏:

```bash
python test_smart_context.py
```

## –ü–µ—Ä–µ–≤–∞–≥–∏ –Ω–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏

1. **–ê–Ω—Ç–∏-—Å–ø–∞–º –∑–∞—Ö–∏—Å—Ç** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏—è–≤–ª—è—î —Å–ø–∞–º —Ç–∞ –∑–º–µ–Ω—à—É—î –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –±–æ—Ç–∞
2. **–†–æ–∑—É–º–Ω–µ —Å—Ç–∏—Å–Ω–µ–Ω–Ω—è –∫–æ–Ω—Ç–µ–∫—Å—Ç—É** - –∑–±–µ—Ä—ñ–≥–∞—î –≤–∞–∂–ª–∏–≤—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é
3. **–ê–¥–∞–ø—Ç–∏–≤–Ω–∞ –ø–æ–≤–µ–¥—ñ–Ω–∫–∞** - –∫–æ—Ä–µ–≥—É—î —Ç–æ–Ω —Ç–∞ —Å—Ç–∏–ª—å –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ —Å–∏—Ç—É–∞—Ü—ñ—ó
4. **–Ø–∫—ñ—Å—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç—É** - –∞–Ω–∞–ª—ñ–∑—É—î –∫–æ–≥–µ—Ä–µ–Ω—Ç–Ω—ñ—Å—Ç—å —Ä–æ–∑–º–æ–≤–∏
5. **–ì–Ω—É—á–∫—ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó** - —Å–∏—Å—Ç–µ–º–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö —Å–∏—Ç—É–∞—Ü—ñ–π
6. **–ü–æ–≤–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è** - –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –¥–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

## –ü—Ä–∏–∫–ª–∞–¥–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

### –ù–æ—Ä–º–∞–ª—å–Ω–∞ —Å–∏—Ç—É–∞—Ü—ñ—è:
```
–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á: "–ì—Ä—è–≥, —è–∫ —Å–ø—Ä–∞–≤–∏?"
–°–∏—Å—Ç–µ–º–∞: should_respond=True, tone="–¥—Ä—É–∂–µ–ª—é–±–Ω–∏–π_–∂–∞—Ä—Ç", length=200
–í—ñ–¥–ø–æ–≤—ñ–¥—å: "–ü—Ä–∏–≤—ñ—Ç! –í—Å–µ —Å—É–ø–µ—Ä, –¥—è–∫—É—é —â–æ –ø–∏—Ç–∞—î—à! üòä"
```

### –°–∏—Ç—É–∞—Ü—ñ—è –∑—ñ —Å–ø–∞–º–æ–º:
```
[30 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –∑–∞ 5 —Ö–≤–∏–ª–∏–Ω]
–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á: "–ó–≤–∏—á–∞–π–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è"
–°–∏—Å—Ç–µ–º–∞: should_respond=False, spam_level="high"
–†–µ–∑—É–ª—å—Ç–∞—Ç: –ë–æ—Ç –º–æ–≤—á–∏—Ç—å –∞–±–æ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î –∞–Ω—Ç–∏-—Å–ø–∞–º –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
```

### –ü–æ–≥–∞–Ω–∞ —è–∫—ñ—Å—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç—É:
```
[–•–∞–æ—Ç–∏—á–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —Ä—ñ–∑–Ω–∏–º–∏ —Ç–µ–º–∞–º–∏]
–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á: "–©–æ –¥—É–º–∞—î—à?"
–°–∏—Å—Ç–µ–º–∞: tone="–Ω–∞–ø—Ä–∞–≤–ª—è—é—á–∏–π_–∂–∞—Ä—Ç", should_provide_guidance=True
–í—ñ–¥–ø–æ–≤—ñ–¥—å: "–ü—Ä–æ —â–æ —Å–∞–º–µ? –î–∞–≤–∞–π—Ç–µ –≤–∏–∑–Ω–∞—á–∏–º–æ—Å—è –∑ —Ç–µ–º–æ—é ü§î"
```

–¶—è —Å–∏—Å—Ç–µ–º–∞ –∑–Ω–∞—á–Ω–æ –ø–æ–∫—Ä–∞—â—É—î —è–∫—ñ—Å—Ç—å –≤–∑–∞—î–º–æ–¥—ñ—ó –±–æ—Ç–∞ –∑ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏ —Ç–∞ –∑–∞–ø–æ–±—ñ–≥–∞—î —Å–ø–∞–º—É —ñ –Ω–æ–Ω—Å–µ–Ω—Å—É.
